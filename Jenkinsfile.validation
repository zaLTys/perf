pipeline {
  agent any

  // Adjust triggers to your VCS system if needed
  triggers {
    githubPush()
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
        sh 'chmod +x jenkins/*.sh'
      }
    }

    stage('Validate YAML syntax') {
      steps {
        sh """#!/bin/bash
          set -euo pipefail
          echo "Validating YAML configs..."
          # yq is used to parse each YAML; replace with your YAML tool if needed.
          find teams -type f -name config.yaml -print0 | xargs -0 -n1 yq e >/dev/null
        """
      }
    }

    stage('k6 dry-run validation (parallel)') {
      steps {
        script {
          def cfgs = sh(
            script: "find teams -type f -name config.yaml",
            returnStdout: true
          ).trim().split("\n")

          def branches = [:]

          cfgs.each { cfg ->
            def name = cfg.replaceAll('.*/', '').replaceAll('/config.yaml', '')

            branches[name] = {
              def js = sh(
                script: "dirname ${cfg} | xargs -I{} echo {}/test.js",
                returnStdout: true
              ).trim()

              sh """#!/bin/bash
                set -euo pipefail
                echo "Dry-run for ${cfg}"
                k6 run --dry-run -e SCENARIO_FILE="${cfg}" "${js}"
              """
            }
          }

          parallel branches
        }
      }
    }
  }

  post {
    always {
      echo "Validation pipeline completed."
    }
  }
}
