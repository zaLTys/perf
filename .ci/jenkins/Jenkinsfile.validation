pipeline {
  agent any

  // Adjust triggers to your VCS system if needed
  triggers {
    githubPush()
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
        sh 'chmod +x .ci/jenkins/scripts/*.sh'
      }
    }

    stage('k6 dry-run validation (parallel)') {
      steps {
        script {
          def testFiles = sh(
            script: "find teams -type f -name test.js",
            returnStdout: true
          ).trim().split("\n")

          def branches = [:]

          testFiles.each { testFile ->
            def name = testFile.replaceAll('.*/', '').replaceAll('/test.js', '').replaceAll('.*/', '')

            branches[name] = {
              sh """#!/bin/bash
                set -euo pipefail
                echo "Dry-run for ${testFile}"
                k6 run --dry-run "${testFile}"
              """
            }
          }

          parallel branches
        }
      }
    }
  }

  post {
    always {
      echo "Validation pipeline completed."
    }
  }
}
