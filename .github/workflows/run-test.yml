name: Run Performance Test

on:
  workflow_dispatch:
    inputs:
      test_name:
        description: 'Test to run (format: teamName_testType_testName)'
        required: true
        type: choice
        options:
          - teamA_load_weather_api
          - teamA_smoke_health_check
          - teamA_spike_weather_api
          - teamA_stress_peak_load
      grafana_url:
        description: 'Grafana URL (optional, for linking results)'
        required: false
        type: string
        default: 'http://localhost:3000'

jobs:
  run-test:
    name: Run ${{ inputs.test_name }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start observability stack
        run: |
          cd docker
          docker compose up -d prometheus grafana
          echo "Waiting for services to be ready..."
          sleep 15
          docker compose ps
          
      - name: Show container logs
        run: |
          cd docker
          echo "=== Prometheus logs ==="
          docker compose logs --tail=20 prometheus
          echo ""
          echo "=== Grafana logs ==="
          docker compose logs --tail=20 grafana
          echo ""
          echo "=== Container status ==="
          docker compose ps

      - name: Find test script
        id: find-test
        run: |
          TEST_NAME="${{ inputs.test_name }}"
          
          # Split by first two underscores: teamA_load_weather_api -> teamA/load/weather_api
          IFS='_' read -ra PARTS <<< "$TEST_NAME"
          if [ ${#PARTS[@]} -ge 3 ]; then
            TEAM="${PARTS[0]}"
            TEST_TYPE="${PARTS[1]}"
            shift=2
            TEST_NAME_JOINED=$(IFS='_'; echo "${PARTS[*]:$shift}")
            TEST_JS="teams/${TEAM}/${TEST_TYPE}/${TEST_NAME_JOINED}/test.js"
          else
            echo "âŒ Invalid test name format"
            exit 1
          fi
          
          if [ ! -f "$TEST_JS" ]; then
            echo "âŒ Test file not found: $TEST_JS"
            echo "Available tests:"
            find teams -name "test.js" -type f
            exit 1
          fi
          
          echo "test_js=$TEST_JS" >> $GITHUB_OUTPUT
          echo "âœ“ Found test: $TEST_JS"

      - name: Run k6 test
        id: run-test
        run: |
          cd docker
          PROMETHEUS_ID=$(docker compose ps -q prometheus)
          if [ -n "$PROMETHEUS_ID" ]; then
            NETWORK=$(docker inspect -f '{{range $k, $_ := .NetworkSettings.Networks}}{{$k}}{{end}}' "$PROMETHEUS_ID")
          fi
          if [ -z "$NETWORK" ]; then
            NETWORK="docker_default"
            echo "âš ï¸ Using default network: $NETWORK"
          else
            echo "âœ“ Detected network: $NETWORK"
          fi
          if ! docker network inspect "$NETWORK" >/dev/null 2>&1; then
            echo "âŒ Error: Network $NETWORK does not exist!"
            docker network ls
            exit 1
          fi
          echo "Using Docker network: $NETWORK"
          
          export K6_PROMETHEUS_RW_SERVER_URL="http://prometheus:9090/api/v1/write"
          export K6_PROMETHEUS_RW_TREND_STATS='p(90),p(95),p(99),min,max,avg,med'
          
          docker run --rm \
            --network "$NETWORK" \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e K6_PROMETHEUS_RW_SERVER_URL \
            -e K6_PROMETHEUS_RW_TREND_STATS \
            grafana/k6:latest run \
            --tag "testid=${{ inputs.test_name }}" \
            --out experimental-prometheus-rw \
            "${{ steps.find-test.outputs.test_js }}"
        continue-on-error: true

      - name: Check test results
        if: steps.run-test.outcome == 'failure'
        run: |
          echo "âŒ Test failed"
          exit 1

      - name: Capture Grafana dashboard snapshot
        if: always() && steps.run-test.outcome != 'cancelled'
        run: |
          cd docker
          # Wait for metrics to be written to Prometheus
          echo "Waiting for metrics to be available..."
          sleep 10
          
          # Get network name
          PROMETHEUS_ID=$(docker compose ps -q prometheus)
          if [ -n "$PROMETHEUS_ID" ]; then
            NETWORK=$(docker inspect -f '{{range $k, $_ := .NetworkSettings.Networks}}{{$k}}{{end}}' "$PROMETHEUS_ID")
          fi
          if [ -z "$NETWORK" ]; then
            NETWORK="docker_default"
          fi
          
          # Get test time range (last 10 minutes to capture the test)
          TEST_NAME="${{ inputs.test_name }}"
          # Calculate timestamps (works on Linux - GitHub Actions uses Ubuntu)
          FROM_TIME=$(($(date +%s) - 600))000
          TO_TIME=$(date +%s)000
          
          # Create dashboard URL with test ID filter and time range
          DASHBOARD_URL="http://grafana:3000/d/k6-dashboard/k6-dashboard?var-testid=${TEST_NAME}&from=${FROM_TIME}&to=${TO_TIME}&kiosk=tv"
          
          echo "Capturing dashboard snapshot..."
          echo "Dashboard URL: ${DASHBOARD_URL}"
          
          # Create output directory
          mkdir -p "${{ github.workspace }}/grafana-snapshots"
          
          # Use Playwright container to capture screenshot
          docker run --rm \
            --network "$NETWORK" \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            mcr.microsoft.com/playwright:v1.40.0-focal \
            sh -c "
              npx playwright install chromium && \
              node -e \"
                const { chromium } = require('playwright');
                (async () => {
                  const browser = await chromium.launch({ headless: true });
                  const page = await browser.newPage();
                  await page.setViewportSize({ width: 1920, height: 1080 });
                  await page.goto('${DASHBOARD_URL}', { waitUntil: 'networkidle', timeout: 30000 });
                  await page.waitForTimeout(5000);
                  await page.screenshot({ path: '/workspace/grafana-snapshots/dashboard-${TEST_NAME}.png', fullPage: true });
                  await browser.close();
                })();
              \"
            "
          
          echo "âœ“ Screenshot captured: grafana-snapshots/dashboard-${TEST_NAME}.png"

      - name: Upload Grafana snapshot
        if: always() && steps.run-test.outcome != 'cancelled'
        uses: actions/upload-artifact@v4
        with:
          name: grafana-dashboard-${{ inputs.test_name }}
          path: grafana-snapshots/dashboard-${{ inputs.test_name }}.png
          retention-days: 30
          if-no-files-found: warn

      - name: Generate summary
        if: always()
        run: |
          TEST_NAME="${{ inputs.test_name }}"
          GRAFANA_URL="${{ inputs.grafana_url }}"
          
          # Create Grafana dashboard link with testid filter
          GRAFANA_LINK="${GRAFANA_URL}/d/k6-dashboard/k6-dashboard?var-testid=${TEST_NAME}"
          
          echo "## ðŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test:** \`${TEST_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.run-test.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ View in Grafana" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [Open Dashboard with Test ID Filter](${GRAFANA_LINK})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if screenshot was captured
          if [ -f "grafana-snapshots/dashboard-${TEST_NAME}.png" ]; then
            echo "### ðŸ“¸ Dashboard Snapshot" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A dashboard snapshot has been captured and uploaded as an artifact." >> $GITHUB_STEP_SUMMARY
            echo "Download it from the workflow artifacts to view the test results." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**Note:** If Grafana is not publicly accessible, use a tunnel (ngrok, Cloudflare Tunnel) or access locally." >> $GITHUB_STEP_SUMMARY

      - name: Show final container logs
        if: always()
        run: |
          cd docker
          echo "=== Final Prometheus logs ==="
          docker compose logs --tail=30 prometheus || true
          echo ""
          echo "=== Final Grafana logs ==="
          docker compose logs --tail=30 grafana || true

      - name: Stop observability stack
        if: always()
        run: |
          cd docker
          docker compose down
